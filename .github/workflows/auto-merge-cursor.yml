name: Auto-merge Cursor-approved PRs

on:
  pull_request_review:
    types: [submitted]

jobs:
  auto-merge:
    # Only run if review is approved and mentions @cursor
    if: github.event.review.state == 'approved'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Auto-merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const review = context.payload.review;
            
            // Check if review body contains cursor mention or is from cursor
            const isCursorReview = review.user.login === 'cursor' || 
                                  (review.body && review.body.toLowerCase().includes('@cursor'));
            
            if (!isCursorReview) {
              console.log('Not a Cursor review, skipping auto-merge');
              return;
            }
            
            console.log(`Auto-merging PR #${pr.number} approved by Cursor`);
            
            // Merge the PR
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              merge_method: 'squash',
              commit_title: `${pr.title} (#${pr.number})`,
              commit_message: `Auto-merged after Cursor review\n\nOriginal PR: ${pr.html_url}`
            });
            
            console.log(`Successfully merged PR #${pr.number}`);
